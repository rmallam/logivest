{% extends "layout.html" %}

{% block title %}Calculation Results{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row">
        <div class="col-12 mb-3">
            <nav aria-label="breadcrumb" class="d-none d-md-block">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('calculator') }}">Calculator</a></li>
                    <li class="breadcrumb-item active">Results</li>
                </ol>
            </nav>
            <h1 class="h3 h1-md fw-bold">
                <i class="fas fa-chart-line text-success me-2"></i> Analysis Results
            </h1>
            <p class="text-muted mb-3 d-none d-md-block">Comprehensive rental yield and return calculations</p>
        </div>
    </div>

    <!-- Property Summary -->
    <div class="row mb-3 mb-md-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white py-2 py-md-3">
                    <h4 class="h6 h4-md mb-0"><i class="fas fa-home me-2"></i> Property Summary</h4>
                </div>
                <div class="card-body p-3">
                    <!-- Mobile: Stacked layout -->
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="text-muted small mb-1">Property Price</div>
                                <div class="h5 h3-md text-primary mb-0">${{ "{:,.0f}".format(property_price) }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="text-muted small mb-1">Weekly Rent</div>
                                <div class="h5 h3-md text-success mb-0">${{ "{:,.0f}".format(weekly_rent) }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="text-muted small mb-1">Monthly Rent</div>
                                <div class="h5 h3-md text-success mb-0">${{ "{:,.0f}".format(monthly_rent) }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">Loan EMI</h5>
                                <h3 class="text-danger mb-0">${{ "{:,.0f}".format(metrics['monthly_payment']) }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Breakdown -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-arrow-up"></i> Income</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td>Weekly Rent</td>
                                <td class="text-end">${{ "{:,.0f}".format(weekly_rent) }}</td>
                            </tr>
                            <tr>
                                <td>Monthly Rent</td>
                                <td class="text-end">${{ "{:,.0f}".format(monthly_rent) }}</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>Annual Rental Income</strong></td>
                                <td class="text-end"><strong>${{ "{:,.0f}".format(monthly_rent * 12) }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-arrow-down"></i> Monthly Outgoings</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td>Loan EMI ({{ "{:.1f}".format(metrics.get('interest_rate', 6.5)) }}% @ {{ metrics.get('loan_term', 30) }} years)</td>
                                <td class="text-end">${{ "{:,.0f}".format(metrics['monthly_payment']) }}</td>
                            </tr>
                            <tr>
                                <td>Property Management ({{ "{:.1f}".format((metrics.get('management_cost', 0) / (monthly_rent * 12) * 100) if monthly_rent > 0 else 0) }}%)</td>
                                <td class="text-end">${{ "{:,.0f}".format(metrics.get('management_cost', 0) / 12) }}</td>
                            </tr>
                            <tr>
                                <td>Insurance & Rates</td>
                                <td class="text-end">${{ "{:,.0f}".format(metrics.get('insurance_rates', 0) / 12) }}</td>
                            </tr>
                            <tr>
                                <td>Maintenance & Repairs</td>
                                <td class="text-end">${{ "{:,.0f}".format(metrics.get('maintenance_repairs', 0) / 12) }}</td>
                            </tr>
                            <tr>
                                <td>Vacancy Allowance</td>
                                <td class="text-end">${{ "{:,.0f}".format(metrics.get('vacancy_cost', 0) / 12) }}</td>
                            </tr>
                            <tr>
                                <td>Other Expenses</td>
                                <td class="text-end">${{ "{:,.0f}".format(metrics.get('other_expenses', 0) / 12) }}</td>
                            </tr>
                            <tr class="table-danger">
                                <td><strong>Total Monthly Expenses</strong></td>
                                <td class="text-end"><strong>${{ "{:,.0f}".format(metrics['monthly_payment'] + (metrics.get('management_cost', 0) + metrics.get('insurance_rates', 0) + metrics.get('maintenance_repairs', 0) + metrics.get('vacancy_cost', 0) + metrics.get('other_expenses', 0)) / 12) }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Upfront Costs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-credit-card"></i> Upfront Investment</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>Down Payment ({{ "{:.0f}".format(metrics['down_payment'] / property_price * 100) }}%)</td>
                                        <td class="text-end">${{ "{:,.0f}".format(metrics['down_payment']) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Agent Commission ({{ "{:.1f}".format(metrics.get('agent_commission', 0) / property_price * 100) }}%)</td>
                                        <td class="text-end">${{ "{:,.0f}".format(metrics.get('agent_commission', 0)) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Other Costs (Legal, Stamp Duty, etc.)</td>
                                        <td class="text-end">${{ "{:,.0f}".format(metrics.get('other_upfront_costs', 0)) }}</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Total Upfront Investment</strong></td>
                                        <td class="text-end"><strong>${{ "{:,.0f}".format(metrics.get('total_upfront_costs', metrics.get('total_cash_invested', 0))) }}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-lg-6">
                            <div class="text-center">
                                <h6 class="text-muted">Loan Details</h6>
                                <p class="mb-1"><strong>Loan Amount:</strong> ${{ "{:,.0f}".format(metrics['loan_amount']) }}</p>
                                <p class="mb-1"><strong>Interest Rate:</strong> {{ "{:.1f}".format(metrics.get('interest_rate', 6.5)) }}%</p>
                                <p class="mb-1"><strong>Loan Term:</strong> {{ metrics.get('loan_term', 30) }} years</p>
                                <p class="mb-0"><strong>LVR:</strong> {{ "{:.1f}".format(metrics['loan_amount'] / property_price * 100) }}%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-percentage"></i> Yield Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-success mb-1">{{ "{:.2f}".format(metrics['gross_yield']) }}%</h4>
                                <p class="text-muted mb-0">Gross Rental Yield</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-primary mb-1">{{ "{:.2f}".format(metrics['net_yield']) }}%</h4>
                            <p class="text-muted mb-0">Net Rental Yield</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-12">
                            <h4 class="text-info mb-1">{{ "{:.2f}".format(metrics['cap_rate']) }}%</h4>
                            <p class="text-muted mb-0">Capitalization Rate</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-dollar-sign"></i> Cash Flow Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-success mb-1">${{ "{:,.0f}".format(metrics['annual_cashflow']) }}</h4>
                                <p class="text-muted mb-0">Annual Cash Flow</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info mb-1">${{ "{:,.0f}".format(metrics['monthly_cashflow']) }}</h4>
                            <p class="text-muted mb-0">Monthly Cash Flow</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-12">
                            <h4 class="text-warning mb-1">{{ "{:.2f}".format(metrics['cash_return']) }}%</h4>
                            <p class="text-muted mb-0">Cash-on-Cash Return</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Investment Score -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-star"></i> Investment Score</h5>
                </div>
                <div class="card-body text-center">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <div class="display-4 fw-bold text-primary">{{ "{:.1f}".format(metrics['investment_score']) }}/10</div>
                                <p class="text-muted mb-0">Overall Investment Score</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="progress mb-3" style="height: 30px;">
                                {% set score_percent = (metrics['investment_score'] / 10) * 100 %}
                                {% if score_percent >= 70 %}
                                    {% set progress_class = "bg-success" %}
                                {% elif score_percent >= 50 %}
                                    {% set progress_class = "bg-warning" %}
                                {% else %}
                                    {% set progress_class = "bg-danger" %}
                                {% endif %}
                                <div class="progress-bar {{ progress_class }}" role="progressbar" 
                                     style="width: {{ score_percent }}%" 
                                     aria-valuenow="{{ score_percent }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ "{:.1f}".format(metrics['investment_score']) }}/10
                                </div>
                            </div>
                            
                            {% if metrics['investment_score'] >= 7 %}
                                <div class="alert alert-success mb-0">
                                    <i class="fas fa-thumbs-up"></i> <strong>Excellent Investment</strong> - Strong returns and cash flow potential
                                </div>
                            {% elif metrics['investment_score'] >= 5 %}
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-balance-scale"></i> <strong>Moderate Investment</strong> - Consider all factors carefully
                                </div>
                            {% else %}
                                <div class="alert alert-danger mb-0">
                                    <i class="fas fa-exclamation-triangle"></i> <strong>Poor Investment</strong> - Low returns may not justify the risk
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rent-to-EMI Analysis -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0"><i class="fas fa-balance-scale"></i> Rent-to-EMI Ratio Analysis</h4>
                    <small>How well does rental income cover mortgage payments</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Main Ratio Display -->
                        <div class="col-md-4 text-center">
                            <div class="p-3 border rounded bg-light">
                                <div class="display-3 text-{{ metrics.rent_to_emi_analysis.color }} fw-bold">
                                    {{ "{:.1f}".format(metrics.rent_to_emi_analysis.ratio_percentage) }}%
                                </div>
                                <h5 class="text-{{ metrics.rent_to_emi_analysis.color }}">{{ metrics.rent_to_emi_analysis.category }}</h5>
                                <p class="text-muted mb-0">{{ metrics.rent_to_emi_analysis.description }}</p>
                            </div>
                        </div>
                        
                        <!-- Breakdown -->
                        <div class="col-md-4">
                            <h6><i class="fas fa-calculator"></i> Monthly Breakdown</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Monthly Rent:</strong></td>
                                    <td class="text-end text-success">${{ "{:,.0f}".format(metrics.rent_to_emi_analysis.monthly_rent) }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Monthly EMI:</strong></td>
                                    <td class="text-end text-danger">-${{ "{:,.0f}".format(metrics.rent_to_emi_analysis.monthly_emi) }}</td>
                                </tr>
                                <tr class="border-top">
                                    <td><strong>Net {% if metrics.rent_to_emi_analysis.is_positive_cashflow %}Surplus{% else %}Shortfall{% endif %}:</strong></td>
                                    <td class="text-end {% if metrics.rent_to_emi_analysis.is_positive_cashflow %}text-success{% else %}text-danger{% endif %}">
                                        <strong>${{ "{:,.0f}".format(metrics.rent_to_emi_analysis.monthly_difference) }}</strong>
                                    </td>
                                </tr>
                            </table>
                            <div class="small text-muted">
                                Annual Impact: <strong class="{% if metrics.rent_to_emi_analysis.is_positive_cashflow %}text-success{% else %}text-danger{% endif %}">
                                    ${{ "{:,.0f}".format(metrics.rent_to_emi_analysis.annual_difference) }}
                                </strong>
                            </div>
                        </div>
                        
                        <!-- Investment Recommendation -->
                        <div class="col-md-4">
                            <h6><i class="fas fa-lightbulb"></i> Investment Recommendation</h6>
                            <div class="alert alert-{{ metrics.rent_to_emi_analysis.color }} mb-2">
                                <strong>{{ metrics.rent_to_emi_recommendations.verdict }}</strong>
                            </div>
                            <ul class="list-unstyled small">
                                <li><strong>Strategy:</strong> {{ metrics.rent_to_emi_recommendations.strategy }}</li>
                                <li><strong>Risk Level:</strong> {{ metrics.rent_to_emi_recommendations.risk_level }}</li>
                                <li><strong>Best For:</strong> {{ metrics.rent_to_emi_recommendations.investor_type }}</li>
                            </ul>
                            <div class="mt-2 p-2 bg-light rounded">
                                <small class="text-muted">
                                    <strong>Action:</strong> {{ metrics.rent_to_emi_recommendations.action }}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Coverage Analysis -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="fas fa-chart-pie"></i> Coverage Analysis</h6>
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ metrics.rent_to_emi_analysis.coverage_analysis.rent_covers_percentage }}%">
                                    {{ "{:.1f}".format(metrics.rent_to_emi_analysis.coverage_analysis.rent_covers_percentage) }}% Covered
                                </div>
                                {% if metrics.rent_to_emi_analysis.coverage_analysis.shortfall_percentage > 0 %}
                                <div class="progress-bar bg-danger" role="progressbar" 
                                     style="width: {{ metrics.rent_to_emi_analysis.coverage_analysis.shortfall_percentage }}%">
                                    {{ "{:.1f}".format(metrics.rent_to_emi_analysis.coverage_analysis.shortfall_percentage) }}% Shortfall
                                </div>
                                {% endif %}
                            </div>
                            {% if metrics.rent_to_emi_analysis.coverage_analysis.monthly_contribution_needed > 0 %}
                            <div class="alert alert-warning">
                                <i class="fas fa-info-circle"></i> 
                                You'll need to contribute <strong>${{ "{:,.0f}".format(metrics.rent_to_emi_analysis.coverage_analysis.monthly_contribution_needed) }} per month</strong> 
                                to cover the EMI shortfall.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Breakdown -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator"></i> Financial Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Metric</th>
                                    <th class="text-end">Annual</th>
                                    <th class="text-end">Monthly</th>
                                    <th class="text-end">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Gross Rental Income</strong></td>
                                    <td class="text-end text-success">${{ "{:,.0f}".format(monthly_rent * 12) }}</td>
                                    <td class="text-end text-success">${{ "{:,.0f}".format(monthly_rent) }}</td>
                                    <td class="text-end text-success">{{ "{:.2f}".format(metrics['gross_yield']) }}%</td>
                                </tr>
                                <tr>
                                    <td><strong>Operating Expenses</strong></td>
                                    <td class="text-end text-danger">-${{ "{:,.0f}".format((metrics.get('management_cost', 0) + metrics.get('insurance_rates', 0) + metrics.get('maintenance_repairs', 0) + metrics.get('vacancy_cost', 0) + metrics.get('other_expenses', 0))) }}</td>
                                    <td class="text-end text-danger">-${{ "{:,.0f}".format((metrics.get('management_cost', 0) + metrics.get('insurance_rates', 0) + metrics.get('maintenance_repairs', 0) + metrics.get('vacancy_cost', 0) + metrics.get('other_expenses', 0)) / 12) }}</td>
                                    <td class="text-end text-muted">-{{ "{:.2f}".format(((metrics.get('management_cost', 0) + metrics.get('insurance_rates', 0) + metrics.get('maintenance_repairs', 0) + metrics.get('vacancy_cost', 0) + metrics.get('other_expenses', 0)) / property_price) * 100) }}%</td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong>Net Operating Income</strong></td>
                                    <td class="text-end"><strong>${{ "{:,.0f}".format(metrics['annual_cashflow']) }}</strong></td>
                                    <td class="text-end"><strong>${{ "{:,.0f}".format(metrics['monthly_cashflow']) }}</strong></td>
                                    <td class="text-end"><strong>{{ "{:.2f}".format(metrics['net_yield']) }}%</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Down Payment Required</strong></td>
                                    <td class="text-end text-info" colspan="2">${{ "{:,.0f}".format(metrics['down_payment']) }}</td>
                                    <td class="text-end text-info">{{ "{:.0f}".format(metrics['down_payment'] / property_price * 100) }}%</td>
                                </tr>
                                <tr class="table-info">
                                    <td><strong>Cash-on-Cash Return</strong></td>
                                    <td class="text-end" colspan="2"><strong>Based on down payment invested</strong></td>
                                    <td class="text-end"><strong>{{ "{:.2f}".format(metrics['cash_return']) }}%</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Capital Gains Forecast -->
    {% if metrics.get('capital_gains_forecast') %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-chart-line"></i> Capital Gains Forecast ({{ metrics.get('projection_years', 10) }} Years)</h4>
                    <small>Property growth at {{ "{:.1f}".format(metrics.get('annual_growth_rate', 5.5)) }}% annually</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Property Value Projection</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Year</th>
                                            <th class="text-end">Property Value</th>
                                            <th class="text-end">Capital Gain</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for year_data in metrics['capital_gains_forecast']['yearly_breakdown'][:5] %}
                                        <tr>
                                            <td><strong>{{ year_data['year'] }}</strong></td>
                                            <td class="text-end">${{ "{:,.0f}".format(year_data['property_value']) }}</td>
                                            <td class="text-end text-success">${{ "{:,.0f}".format(year_data['cumulative_gain']) }}</td>
                                        </tr>
                                        {% endfor %}
                                        <tr class="table-success">
                                            <td><strong>{{ metrics.get('projection_years', 10) }} Years</strong></td>
                                            <td class="text-end"><strong>${{ "{:,.0f}".format(metrics['capital_gains_forecast']['final_value']) }}</strong></td>
                                            <td class="text-end"><strong>${{ "{:,.0f}".format(metrics['capital_gains_forecast']['total_gain']) }}</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Total Return Analysis</h5>
                            {% if metrics.get('total_return_projection') %}
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-12 mb-3">
                                            <h4 class="text-success mb-0">${{ "{:,.0f}".format(metrics['total_return_projection']['total_cash_flow']) }}</h4>
                                            <small class="text-muted">Total Cash Flow ({{ metrics.get('projection_years', 10) }} years)</small>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <h4 class="text-primary mb-0">${{ "{:,.0f}".format(metrics['total_return_projection']['total_capital_gains']) }}</h4>
                                            <small class="text-muted">Total Capital Gains</small>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <h3 class="text-success mb-0">${{ "{:,.0f}".format(metrics['total_return_projection']['total_return']) }}</h3>
                                            <small class="text-muted"><strong>Combined Total Return</strong></small>
                                        </div>
                                        <div class="col-12">
                                            <h4 class="text-warning mb-0">{{ "{:.1f}".format(metrics['total_return_projection']['annualized_return'] * 100) }}%</h4>
                                            <small class="text-muted">Annualized Return</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Key Insights -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6><i class="fas fa-lightbulb text-warning"></i> Key Insights:</h6>
                        <ul class="mb-0">
                            <li>Property value expected to grow from <strong>${{ "{:,.0f}".format(property_price) }}</strong> to <strong>${{ "{:,.0f}".format(metrics['capital_gains_forecast']['final_value']) }}</strong></li>
                            <li>Total capital gain over {{ metrics.get('projection_years', 10) }} years: <strong>${{ "{:,.0f}".format(metrics['capital_gains_forecast']['total_gain']) }}</strong></li>
                            {% if metrics.get('total_return_projection') %}
                            <li>Combined returns (cash flow + capital gains): <strong>${{ "{:,.0f}".format(metrics['total_return_projection']['total_return']) }}</strong></li>
                            <li>Annualized return on investment: <strong>{{ "{:.1f}".format(metrics['total_return_projection']['annualized_return'] * 100) }}%</strong></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Investment Summary & Recommendations -->
    {% if metrics.get('investment_summary') %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-lightbulb"></i> Investment Analysis Summary</h4>
                    <small>Clear recommendations based on your investment strategy</small>
                </div>
                <div class="card-body">
                    {% set summary = metrics['investment_summary'] %}
                    
                    <!-- Rental Income Strategy -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-coins text-warning"></i> For Rental Income Strategy</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4 class="mb-2">
                                                {% if 'EXCELLENT' in summary['overall_recommendation']['rental_only_verdict'] %}
                                                    <span class="badge bg-success fs-6">{{ summary['overall_recommendation']['rental_only_verdict'] }}</span>
                                                {% elif 'GOOD' in summary['overall_recommendation']['rental_only_verdict'] %}
                                                    <span class="badge bg-primary fs-6">{{ summary['overall_recommendation']['rental_only_verdict'] }}</span>
                                                {% elif 'FAIR' in summary['overall_recommendation']['rental_only_verdict'] %}
                                                    <span class="badge bg-warning fs-6">{{ summary['overall_recommendation']['rental_only_verdict'] }}</span>
                                                {% else %}
                                                    <span class="badge bg-danger fs-6">{{ summary['overall_recommendation']['rental_only_verdict'] }}</span>
                                                {% endif %}
                                            </h4>
                                            <p class="mb-3">{{ summary['overall_recommendation']['rental_only_reason'] }}</p>
                                            
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <strong>Rental Yield:</strong> {{ summary['rental_analysis']['category'] }}<br>
                                                    <small class="text-muted">{{ summary['rental_analysis']['description'] }}</small>
                                                </div>
                                                <div class="col-sm-6">
                                                    <strong>Cash Flow:</strong> {{ summary['cashflow_analysis']['status'] }}<br>
                                                    <small class="text-muted">{{ summary['cashflow_analysis']['impact'] }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="p-3 bg-white rounded border">
                                                <h3 class="text-primary mb-0">{{ "{:.1f}".format(metrics['net_yield']) }}%</h3>
                                                <small class="text-muted">Net Rental Yield</small>
                                                <hr>
                                                <h4 class="mb-0 
                                                    {% if metrics['monthly_cashflow'] > 0 %}text-success{% else %}text-danger{% endif %}">
                                                    ${{ "{:,.0f}".format(metrics['monthly_cashflow']) }}
                                                </h4>
                                                <small class="text-muted">Monthly Cash Flow</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Combined Strategy (if capital gains available) -->
                    {% if summary.get('capital_analysis') %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-line text-success"></i> Including Capital Gains Potential</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4 class="mb-2">
                                                {% if 'EXCELLENT' in summary['overall_recommendation']['combined_verdict'] %}
                                                    <span class="badge bg-success fs-6">{{ summary['overall_recommendation']['combined_verdict'] }}</span>
                                                {% elif 'VERY GOOD' in summary['overall_recommendation']['combined_verdict'] %}
                                                    <span class="badge bg-success fs-6">{{ summary['overall_recommendation']['combined_verdict'] }}</span>
                                                {% elif 'GOOD' in summary['overall_recommendation']['combined_verdict'] %}
                                                    <span class="badge bg-primary fs-6">{{ summary['overall_recommendation']['combined_verdict'] }}</span>
                                                {% elif 'FAIR' in summary['overall_recommendation']['combined_verdict'] %}
                                                    <span class="badge bg-warning fs-6">{{ summary['overall_recommendation']['combined_verdict'] }}</span>
                                                {% else %}
                                                    <span class="badge bg-danger fs-6">{{ summary['overall_recommendation']['combined_verdict'] }}</span>
                                                {% endif %}
                                            </h4>
                                            <p class="mb-3">{{ summary['overall_recommendation']['combined_reason'] }}</p>
                                            
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <strong>Capital Growth:</strong> {{ summary['capital_analysis']['category'] }}<br>
                                                    <small class="text-muted">{{ summary['capital_analysis']['description'] }}</small>
                                                </div>
                                                <div class="col-sm-6">
                                                    <strong>Total Return:</strong> {{ "{:.1f}".format(summary['capital_analysis']['annualized_return']) }}% annually<br>
                                                    <small class="text-muted">Combined income + capital growth</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="p-3 bg-white rounded border">
                                                <h3 class="text-success mb-0">{{ "{:.1f}".format(summary['capital_analysis']['annualized_return']) }}%</h3>
                                                <small class="text-muted">Total Annual Return</small>
                                                <hr>
                                                <h4 class="text-primary mb-0">${{ "{:,.0f}".format(summary['capital_analysis']['total_gain']) }}</h4>
                                                <small class="text-muted">{{ summary['capital_analysis']['projection_years'] }}-Year Capital Gain</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Key Takeaways -->
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Key Takeaways:</h6>
                                <ul class="mb-0">
                                    <li><strong>For Income Investors:</strong> {{ summary['rental_analysis']['recommendation'] }}</li>
                                    {% if summary.get('capital_analysis') %}
                                    <li><strong>For Growth Investors:</strong> Property expected to appreciate {{ "{:.1f}".format(summary['capital_analysis']['annualized_return']) }}% annually over {{ summary['capital_analysis']['projection_years'] }} years</li>
                                    <li><strong>Combined Strategy:</strong> Total returns of {{ "{:.1f}".format(summary['capital_analysis']['annualized_return']) }}% annually make this 
                                        {% if summary['capital_analysis']['annualized_return'] >= 10 %}an excellent
                                        {% elif summary['capital_analysis']['annualized_return'] >= 7 %}a very good
                                        {% elif summary['capital_analysis']['annualized_return'] >= 5 %}a reasonable
                                        {% else %}a poor{% endif %} investment choice</li>
                                    {% endif %}
                                    <li><strong>Investment Score:</strong> {{ "{:.1f}".format(summary['investment_score']) }}/10 
                                        {% if summary['investment_score'] >= 8 %}(Excellent)
                                        {% elif summary['investment_score'] >= 6 %}(Good)
                                        {% elif summary['investment_score'] >= 4 %}(Fair)
                                        {% else %}(Poor){% endif %}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Holding Period Recommendations -->
    {% if metrics.get('holding_recommendations') %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-calendar-alt"></i> Optimal Holding Period Strategy</h4>
                    <small>Maximize your returns with strategic timing</small>
                </div>
                <div class="card-body">
                    {% set holding = metrics['holding_recommendations'] %}
                    
                    <!-- Strategic Advice Cards -->
                    <div class="row mb-4">
                        {% for strategy in holding['strategic_advice'] %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 
                                {% if strategy['roi'] >= 12 %}border-success
                                {% elif strategy['roi'] >= 8 %}border-primary
                                {% elif strategy['roi'] >= 5 %}border-warning
                                {% else %}border-secondary{% endif %}">
                                <div class="card-header text-center 
                                    {% if strategy['roi'] >= 12 %}bg-success text-white
                                    {% elif strategy['roi'] >= 8 %}bg-primary text-white
                                    {% elif strategy['roi'] >= 5 %}bg-warning text-dark
                                    {% else %}bg-secondary text-white{% endif %}">
                                    <h6 class="mb-0">{{ strategy['strategy'] }}</h6>
                                </div>
                                <div class="card-body text-center">
                                    <h3 class="text-primary">{{ strategy['timeframe'] }}</h3>
                                    <h4 class="text-success">${{ "{:,.0f}".format(strategy['profit']) }}</h4>
                                    <small class="text-muted">Total Profit</small>
                                    <hr>
                                    <h5 class="mb-0">{{ "{:.1f}".format(strategy['roi']) }}%</h5>
                                    <small class="text-muted">Annual Return</small>
                                    <p class="mt-2 mb-0"><small>{{ strategy['description'] }}</small></p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Detailed Projections Table -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="mb-3">Detailed Profit Projections</h5>
                            <div class="alert alert-warning">
                                <strong>Note:</strong> The "Cash Flow" in this table now includes loan payments for accurate net cash flow analysis. 
                                This matches the Year-by-Year breakdown below for consistency.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Holding Period</th>
                                            <th class="text-end">Property Value</th>
                                            <th class="text-end">Capital Gain</th>
                                            <th class="text-end">Cash Flow</th>
                                            <th class="text-end">Total Profit</th>
                                            <th class="text-end">Annual ROI</th>
                                            <th>Recommendation</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for period in holding['all_periods'] %}
                                        <tr class="
                                            {% if period['annualized_roi'] >= 12 %}table-success
                                            {% elif period['annualized_roi'] >= 8 %}table-primary
                                            {% elif period['annualized_roi'] >= 5 %}table-warning
                                            {% endif %}">
                                            <td><strong>{{ period['years'] }} years</strong></td>
                                            <td class="text-end">${{ "{:,.0f}".format(period['future_property_value']) }}</td>
                                            <td class="text-end text-success">${{ "{:,.0f}".format(period['capital_gain']) }}</td>
                                            <td class="text-end text-info">${{ "{:,.0f}".format(period['total_cash_flow']) }}</td>
                                            <td class="text-end"><strong>${{ "{:,.0f}".format(period['total_profit']) }}</strong></td>
                                            <td class="text-end"><strong>{{ "{:.1f}".format(period['annualized_roi']) }}%</strong></td>
                                            <td>
                                                <span class="badge 
                                                    {% if period['category'] == 'Excellent' %}bg-success
                                                    {% elif period['category'] == 'Very Good' %}bg-primary
                                                    {% elif period['category'] == 'Good' %}bg-info
                                                    {% elif period['category'] == 'Fair' %}bg-warning
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ period['category'] }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Year-by-Year Cash Flow Breakdown -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="mb-3"><i class="fas fa-chart-line"></i> Year-by-Year Cash Flow Analysis</h5>
                            <div class="alert alert-info">
                                <strong>Understanding True Cash Flow:</strong> This shows your actual out-of-pocket cost or profit each year.
                                <br><strong>Formula:</strong> Rental Income - Operating Expenses - Loan Payments = Net Cash Flow
                                <br><strong>Negative values</strong> mean you contribute money monthly. <strong>Positive values</strong> mean the property pays you.
                            </div>
                            
                            <!-- Cash Flow Types Explanation -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="fas fa-info-circle"></i> Cash Flow Types Explained</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong> Net Cash Flow (Real Cost/Profit)</strong>
                                                    <p class="small mb-2">Rent - Expenses - Loan Payments</p>
                                                    <p class="small text-muted">What you actually pay or receive monthly. Used in both tables below for consistency.</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong> Total Investment Return</strong>
                                                    <p class="small mb-2">Cash Flow + Capital Gains</p>
                                                    <p class="small text-muted">Includes property appreciation. True investment performance measure.</p>
                                                </div>
                                            </div>
                                            
                                            <!-- Break-even Explanation -->
                                            <div class="mt-3 p-2 bg-light rounded">
                                                <small class="text-muted">
                                                    <strong>Key Insight:</strong> Year-by-year cash flow shows operational performance only. 
                                                    Even with negative monthly cash flow, your total investment can be profitable due to property appreciation.
                                                    {% if metrics.breakeven_analysis.explanation %}
                                                    <br><br>{{ metrics.breakeven_analysis.explanation }}
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Year</th>
                                            <th class="text-end">Rental Income</th>
                                            <th class="text-end">Loan Payment</th>
                                            <th class="text-end">Operating Expenses</th>
                                            <th class="text-end">Net Cash Flow</th>
                                            <th class="text-end">Cumulative</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% set ns = namespace(cumulative=0, annual_rent=monthly_rent * 12, annual_payment=metrics.monthly_payment * 12) %}
                                        {% for year in range(1, 11) %}
                                        {% set year_rent = ns.annual_rent * (1.025 ** (year - 1)) %}
                                        {% set year_cashflow = year_rent - ns.annual_payment - metrics.total_annual_expenses %}
                                        {% set ns.cumulative = ns.cumulative + year_cashflow %}
                                        <tr class="{% if year_cashflow >= 0 %}table-success{% else %}table-danger{% endif %}">
                                            <td><strong>{{ year }}</strong></td>
                                            <td class="text-end">${{ "{:,.0f}".format(year_rent) }}</td>
                                            <td class="text-end text-danger">-${{ "{:,.0f}".format(ns.annual_payment) }}</td>
                                            <td class="text-end text-warning">-${{ "{:,.0f}".format(metrics.total_annual_expenses) }}</td>
                                            <td class="text-end {% if year_cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                <strong>${{ "{:,.0f}".format(year_cashflow) }}</strong>
                                            </td>
                                            <td class="text-end {% if ns.cumulative >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                ${{ "{:,.0f}".format(ns.cumulative) }}
                                            </td>
                                            <td>
                                                {% if year_cashflow >= 5000 %}
                                                <span class="badge bg-success">Excellent</span>
                                                {% elif year_cashflow >= 0 %}
                                                <span class="badge bg-primary">Positive</span>
                                                {% elif year_cashflow >= -5000 %}
                                                <span class="badge bg-warning">Manageable</span>
                                                {% else %}
                                                <span class="badge bg-danger">Negative</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Cash Flow Summary -->
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Year 1 Cash Flow</h6>
                                            {% set year1_cashflow = (monthly_rent * 12) - (metrics.monthly_payment * 12) - metrics.total_annual_expenses %}
                                            <h4 class="{% if year1_cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                ${{ "{:,.0f}".format(year1_cashflow) }}
                                            </h4>
                                            <small class="text-muted">Current year performance</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Monthly Cash Impact</h6>
                                            <h4 class="{% if metrics.monthly_cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                ${{ "{:,.0f}".format(metrics.monthly_cashflow) }}
                                            </h4>
                                            <small class="text-muted">Monthly out-of-pocket</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Break-even Analysis</h6>
                                            {% if metrics.breakeven_analysis.operational_breakeven_years %}
                                                <h4 class="text-success">{{ metrics.breakeven_analysis.operational_breakeven_years }} years</h4>
                                                <small class="text-muted">Cash flow turns positive</small>
                                            {% else %}
                                                <h4 class="text-warning">Never</h4>
                                                <small class="text-muted">Requires ongoing funding</small>
                                            {% endif %}
                                            {% if metrics.breakeven_analysis.total_return_breakeven_years %}
                                                <hr class="my-2">
                                                <div class="small">
                                                    <strong class="text-primary">Total ROI: {{ metrics.breakeven_analysis.total_return_breakeven_years }} years</strong>
                                                    <br><span class="text-muted">Including capital gains</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Insights -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-star"></i> Strategic Insights:</h6>
                                <ul class="mb-0">
                                    {% if holding['break_even_years'] %}
                                    <li><strong>Total Return Break-even:</strong> {{ holding['break_even_years'] }} years - when investment becomes profitable (including capital gains)</li>
                                    {% else %}
                                    <li><strong>Total Return Break-even:</strong> Not achieved within 20 years - high-risk investment</li>
                                    {% endif %}
                                    
                                    {% if holding['cash_flow_breakeven_years'] %}
                                    <li><strong>Cash Flow Break-even:</strong> {{ holding['cash_flow_breakeven_years'] }} years - when property pays for itself operationally</li>
                                    {% else %}
                                    <li><strong>Cash Flow:</strong> Remains negative - requires ongoing monthly contributions</li>
                                    {% endif %}
                                    
                                    {% if holding['best_short_term'] and holding['best_short_term']['annualized_roi'] > 0 %}
                                    <li><strong>Short-term Strategy (3 years):</strong> ${{ "{:,.0f}".format(holding['best_short_term']['total_profit']) }} profit ({{ "{:.1f}".format(holding['best_short_term']['annualized_roi']) }}% annually)</li>
                                    {% else %}
                                    <li><strong>Short-term Strategy:</strong> Not recommended - negative returns over 3 years</li>
                                    {% endif %}
                                    
                                    {% if holding['best_medium_term'] and holding['best_medium_term']['annualized_roi'] > 0 %}
                                    <li><strong>Medium-term Strategy (5 years):</strong> ${{ "{:,.0f}".format(holding['best_medium_term']['total_profit']) }} profit ({{ "{:.1f}".format(holding['best_medium_term']['annualized_roi']) }}% annually)</li>
                                    {% else %}
                                    <li><strong>Medium-term Strategy:</strong> Not recommended - negative returns over 5 years</li>
                                    {% endif %}
                                    
                                    {% if holding['best_long_term'] and holding['best_long_term']['annualized_roi'] > 0 %}
                                    <li><strong>Long-term Wealth Building (10+ years):</strong> ${{ "{:,.0f}".format(holding['best_long_term']['total_profit']) }} profit ({{ "{:.1f}".format(holding['best_long_term']['annualized_roi']) }}% annually)</li>
                                    {% else %}
                                    <li><strong>Long-term Strategy:</strong> Poor returns even over 10+ years</li>
                                    {% endif %}
                                    
                                    <li><strong>Initial Investment:</strong> ${{ "{:,.0f}".format(holding['initial_investment']) }} down payment required</li>
                                    <li><strong>Growth Assumptions:</strong> {{ "{:.1f}".format(holding['annual_growth_rate']) }}% annual property appreciation + 2.5% rent growth</li>
                                    
                                    {% if metrics.breakeven_analysis.current_monthly_shortfall > 0 %}
                                    <li><strong>Monthly Funding Required:</strong> ${{ "{:,.0f}".format(metrics.breakeven_analysis.current_monthly_shortfall) }} per month initially</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12 text-center">
            <a href="{{ url_for('calculator') }}" class="btn btn-primary btn-lg me-3">
                <i class="fas fa-calculator"></i> New Calculation
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-home"></i> Back to Search
            </a>
        </div>
    </div>
</div>
{% endblock %}
